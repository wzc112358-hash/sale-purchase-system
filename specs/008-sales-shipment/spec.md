# Feature Specification: 销售-发货管理

**Feature Branch**: `008-sales-shipment`  
**Created**: 2026-02-19  
**Status**: Draft  
**Input**: User description: "销售-发货管理：实现销售发货列表页面（展示运输合同号、品名、合同编号、物流公司、发货日期、数量、运费状态、发票状态），支持搜索和筛选；发货详情页面；发货新增/编辑弹窗（选择关联的销售合同、输入运输合同号、发货日期、发货数量、物流公司、发货地址、收货地址、运费金额、运费状态、发票状态、上传物流单据附件、备注）；删除发货记录功能；发货附件查看和下载功能；发货后自动更新合同执行进度。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看发货列表 (Priority: P1)

销售职员可以查看所有发货记录列表，包括运输合同号、品名、合同编号、物流公司、发货日期、数量、运费状态、发票状态等信息，并支持搜索和筛选功能。

**Why this priority**: 这是发货管理的基础功能，用户需要先能看到数据才能进行后续操作。

**Independent Test**: 可通过打开发货列表页面，验证表格是否正确显示所有发货记录，并验证搜索和筛选功能是否正常工作。

**Acceptance Scenarios**:

1. **Given** 系统存在多条发货记录，**When** 用户打开发货列表页面，**Then** 页面显示所有发货记录，每条记录包含运输合同号、品名、合同编号、物流公司、发货日期、数量、运费状态、发票状态
2. **Given** 系统存在多条发货记录，**When** 用户输入搜索条件并点击搜索，**Then** 列表显示符合搜索条件的记录
3. **Given** 系统存在多条发货记录，**When** 用户使用筛选功能，**Then** 列表显示符合筛选条件的记录

---

### User Story 2 - 创建发货记录 (Priority: P1)

销售职员可以创建新的发货记录，选择关联的销售合同，填写运输合同号、发货日期、发货数量、物流公司、发货地址、收货地址、运费金额等信息，并可上传物流单据附件。

**Why this priority**: 核心业务功能，允许用户添加新的发货批次，是销售流程中的必要操作。

**Independent Test**: 可通过点击新增按钮，填写表单并提交，验证发货记录是否成功创建，并检查关联的销售合同执行进度是否更新。

**Acceptance Scenarios**:

1. **Given** 存在有效的销售合同，**When** 用户点击新增发货按钮并填写完整信息后点击保存，**Then** 系统创建新的发货记录并显示在列表中
2. **Given** 用户未填写必填字段，**When** 用户点击保存按钮，**Then** 系统显示错误提示，要求填写必填字段
3. **Given** 用户填写了必填信息并上传了附件，**When** 点击保存后，**Then** 附件成功上传并关联到发货记录

---

### User Story 3 - 编辑发货记录 (Priority: P1)

销售职员可以编辑已有的发货记录信息。

**Why this priority**: 允许用户修正输入错误或更新发货信息，是常见操作需求。

**Independent Test**: 可通过点击列表中的编辑按钮，修改表单内容并保存，验证信息是否成功更新。

**Acceptance Scenarios**:

1. **Given** 存在一条发货记录，**When** 用户点击编辑按钮并修改信息后保存，**Then** 系统更新发货记录并反映最新信息
2. **Given** 存在一条发货记录，**When** 用户尝试编辑但未做任何修改直接保存，**Then** 系统保持记录不变

---

### User Story 4 - 删除发货记录 (Priority: P2)

销售职员可以删除不需要的发货记录。

**Why this priority**: 允许用户删除误创建或无效的记录，保持数据准确性。

**Independent Test**: 可通过点击删除按钮并确认，验证记录是否从列表中移除。

**Acceptance Scenarios**:

1. **Given** 存在一条发货记录，**When** 用户点击删除按钮并确认删除，**Then** 系统从数据库中删除该记录，列表不再显示
2. **Given** 存在一条发货记录，**When** 用户点击删除按钮但取消删除，**Then** 系统保持记录不变

---

### User Story 5 - 查看发货详情 (Priority: P2)

销售职员可以查看单条发货记录的详细信息，包括关联的合同信息。

**Why this priority**: 用户需要查看完整信息进行核对或跟进。

**Independent Test**: 可通过点击列表中的记录，验证详情页面是否显示完整的发货信息和关联合同信息。

**Acceptance Scenarios**:

1. **Given** 存在一条发货记录，**When** 用户点击该记录，**Then** 页面显示完整的发货详情，包括关联的销售合同信息

---

### User Story 6 - 查看和下载附件 (Priority: P3)

销售职员可以查看和下载发货记录关联的物流单据附件。

**Why this priority**: 附件是发货凭证，用户需要能够查看和下载进行确认或存档。

**Independent Test**: 可通过点击附件链接或按钮，验证附件是否能够正确打开或下载。

**Acceptance Scenarios**:

1. **Given** 发货记录包含附件，**When** 用户点击附件链接，**Then** 附件在新窗口打开或开始下载
2. **Given** 发货记录不包含附件，**When** 用户查看详情，**Then** 显示"暂无附件"或类似提示

---

### Edge Cases

- 当用户尝试为已完成的合同创建发货时，系统应如何处理？提示用户合同已完成或允许创建但给出警告
- 当发货数量超过合同剩余数量时，系统应如何处理？提示数量超出限制
- 当关联的销售合同被删除时，系统应如何处理？不允许删除或给出提示
- 当网络中断导致附件上传失败时，系统应如何处理？显示上传失败提示并允许重试
- 当用户在同一时间多次提交相同的发货请求时，系统应如何处理？防止重复提交

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供发货列表页面，展示所有发货记录的核心字段信息
- **FR-002**: 系统必须支持按运输合同号、品名、合同编号、物流公司、发货日期等条件进行搜索
- **FR-003**: 系统必须支持按运费状态、发票状态等条件进行筛选
- **FR-004**: 用户必须能够创建新的发货记录，包含所有必填字段
- **FR-005**: 用户必须能够编辑已有发货记录的信息
- **FR-006**: 用户必须能够删除发货记录
- **FR-007**: 系统必须提供分页功能，每页显示一定数量的记录
- **FR-008**: 系统必须提供发货详情页面，展示完整的发货信息和关联合同信息
- **FR-009**: 系统必须支持上传物流单据附件（运单、签收单等）
- **FR-010**: 系统必须支持查看和下载发货附件
- **FR-011**: 发货创建/更新后，系统必须自动更新关联销售合同的执行进度
- **FR-012**: 销售职员只能管理本人创建的发货记录（根据权限矩阵）

### Key Entities *(include if feature involves data)*

- **发货记录 (Sales Shipment)**: 代表一次发货批次，包含运输合同号、产品名称、发货数量、物流信息、运费状态、发票状态等
- **销售合同 (Sales Contract)**: 关联的发货的合同，记录合同信息和执行进度

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在发货列表页面查看所有发货记录，响应时间不超过2秒
- **SC-002**: 用户可以成功创建、编辑、删除发货记录，操作成功率达到95%以上
- **SC-003**: 发货后关联销售合同的执行进度自动更新，更新准确率达到100%
- **SC-004**: 用户可以通过搜索和筛选功能快速定位目标记录，搜索结果准确
- **SC-005**: 用户可以上传和下载附件，附件完整性得到保证

## Assumptions

- 销售合同管理功能（步骤07）已经完成并可用
- 后端已配置好销售发货数据表的API访问规则
- 后端已实现发货后自动更新合同执行进度的钩子逻辑
- 用户已登录系统并具有销售职员角色权限
