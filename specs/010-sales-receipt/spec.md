# Feature Specification: 销售-收款管理

**Feature Branch**: `010-sales-receipt`  
**Created**: 2026-02-21  
**Status**: Draft  
**Input**: User description: "步骤10: feature-sales-receipt - 销售-收款管理"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 销售收款记录管理 (Priority: P1)

作为销售职员，我需要能够查看、创建、编辑和删除收款记录，以便管理销售合同的回款信息。

**Why this priority**: 收款管理是销售流程的核心环节，必须首先实现基本的增删改查功能。

**Independent Test**: 可以通过创建、查看、编辑、删除一条收款记录来完整测试。

**Acceptance Scenarios**:

1. **Given** 用户在收款列表页面，**When** 点击"新增收款"按钮并填写表单提交，**Then** 收款记录成功创建并显示在列表中
2. **Given** 收款列表中有记录，**When** 点击某条记录的编辑按钮并修改信息后提交，**Then** 记录成功更新
3. **Given** 收款列表中有记录，**When** 点击删除按钮并确认删除，**Then** 记录被成功删除
4. **Given** 收款列表中有记录，**When** 点击某条记录的查看按钮，**Then** 显示该收款的详细信息

---

### User Story 2 - 收款进度自动更新 (Priority: P1)

作为销售职员，我需要在完成收款后自动看到合同收款进度和欠款金额的更新，减少手动计算工作。

**Why this priority**: 自动计算是系统的核心价值，提高工作效率并减少错误。

**Independent Test**: 创建收款记录后，检查关联销售合同的收款进度百分比和欠款金额是否正确更新。

**Acceptance Scenarios**:

1. **Given** 销售合同总金额为10000，已收款0，**When** 新增一笔5000的收款，**Then** 合同收款进度变为50%，欠款变为5000
2. **Given** 销售合同总金额为10000，已收款5000，**When** 删除该收款记录，**Then** 合同收款进度变回0%，欠款变回10000

---

### User Story 3 - 收款凭证管理 (Priority: P2)

作为销售职员，我需要上传和管理收款凭证（如银行回单、转账记录），以便留存证据。

**Why this priority**: 财务凭证管理是销售收款流程的重要组成部分。

**Independent Test**: 在新增/编辑收款时可以上传附件，并能够查看和下载已上传的凭证。

**Acceptance Scenarios**:

1. **Given** 在收款新增/编辑弹窗中，**When** 选择文件并上传收款凭证，**Then** 凭证成功上传并保存
2. **Given** 收款记录已上传凭证，**When** 在详情页面点击下载按钮，**Then** 凭证文件开始下载

---

### User Story 4 - 收款列表查询筛选 (Priority: P2)

作为销售职员，我需要能够按合同编号、品名、收款日期等条件搜索和筛选收款记录，快速找到目标记录。

**Why this priority**: 提高查找效率，尤其在记录较多时。

**Acceptance Scenarios**:

1. **Given** 收款列表有多条记录，**When** 在搜索框输入合同编号，**Then** 列表只显示匹配的记录
2. **Given** 收款列表有多条记录，**When** 使用日期筛选选择特定月份，**Then** 列表只显示该月的记录

---

### Edge Cases

- 当收款金额超过合同总金额时如何处理？
- 当删除的收款记录关联的合同已被删除时如何处理？
- 当网络异常导致收款记录保存失败时如何反馈用户？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须提供销售收款列表页面，展示合同编号、品名、收款日期、收款金额、产品数量、收款方式等信息
- **FR-002**: 系统必须支持新增收款记录功能，包括选择关联的销售合同、输入收款金额、产品数量、收款日期、收款方式、收款账户、上传凭证、添加备注
- **FR-003**: 系统必须支持编辑已有收款记录的功能
- **FR-004**: 系统必须支持删除收款记录的功能，并要求二次确认
- **FR-005**: 系统必须支持查看收款详情页面的功能
- **FR-006**: 系统必须在创建/更新/删除收款记录后自动更新关联销售合同的收款进度（receipt_percent）、已收款金额（receipted_amount）、欠款金额（debt_amount）、欠款百分比（debt_percent）
- **FR-007**: 系统必须支持上传收款凭证附件（银行回单、转账记录等）
- **FR-008**: 系统必须支持查看和下载已上传的收款凭证
- **FR-009**: 系统必须支持按合同编号、品名、收款日期等条件搜索和筛选收款记录
- **FR-010**: 系统必须支持分页展示收款列表

### Key Entities

- **收款记录 (SaleReceipt)**: 关联销售合同，记录收款金额、产品数量、收款日期、收款方式、收款账户、凭证附件、备注信息
- **销售合同 (SalesContract)**: 被收款记录关联，包含总金额、已收款金额、收款进度、欠款金额等自动计算字段

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 销售职员可以在10秒内完成新增一笔收款记录的操作
- **SC-002**: 收款记录创建后，关联合同的收款进度和欠款金额在5秒内自动更新完成
- **SC-003**: 用户可以成功查看、下载已上传的收款凭证文件
- **SC-004**: 收款列表支持分页，每页默认显示10条记录
- **SC-005**: 搜索和筛选功能响应时间在3秒以内
