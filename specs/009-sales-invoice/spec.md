# Feature Specification: 销售发票管理

**Feature Branch**: `009-sales-invoice`  
**Created**: 2026-02-20  
**Status**: Draft  
**Input**: User description: "销售-发票管理：实现销售发票的增删改查，开票后自动更新合同开票进度"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查看发票列表 (Priority: P1)

作为销售职员，我需要查看所有发票记录，以便了解开票情况。

**Why this priority**: 这是最基本的查看功能，是其他所有功能的前提

**Independent Test**: 可以通过查看发票列表测试，显示发票号码、品名、合同编号、开票日期、发票金额

**Acceptance Scenarios**:

1. **Given** 系统有发票数据，**When** 用户访问发票列表页面，**Then** 显示所有发票的表格
2. **Given** 有多条发票记录，**When** 用户查看列表，**Then** 支持分页显示

---

### User Story 2 - 新增发票记录 (Priority: P1)

作为销售职员，我需要新增发票记录，以便记录开票信息。

**Why this priority**: 核心业务功能，用于记录销售发票信息

**Independent Test**: 可以通过新增发票测试，输入发票号码、关联合同、发票类型、数量、金额、日期后保存成功

**Acceptance Scenarios**:

1. **Given** 用户在发票列表页面，**When** 点击新增按钮，**Then** 弹出新增发票表单
2. **Given** 用户填写完整信息并提交，**Then** 发票记录保存成功，列表刷新显示新记录

---

### User Story 3 - 编辑发票信息 (Priority: P1)

作为销售职员，我需要编辑发票信息，以便修正错误或更新信息。

**Why this priority**: 日常业务中经常需要修改发票信息

**Independent Test**: 可以通过编辑发票测试，修改发票信息后保存成功

**Acceptance Scenarios**:

1. **Given** 发票列表中有记录，**When** 用户点击编辑按钮，**Then** 弹出编辑表单并加载当前数据
2. **Given** 用户修改信息并提交，**Then** 发票记录更新成功

---

### User Story 4 - 删除发票记录 (Priority: P2)

作为销售职员，我需要删除发票记录，以便移除错误或无效的记录。

**Why this priority**: 清理错误数据的必要功能

**Independent Test**: 可以通过删除发票测试，确认删除后记录从列表中移除

**Acceptance Scenarios**:

1. **Given** 发票列表中有记录，**When** 用户点击删除按钮，**Then** 弹出确认对话框
2. **Given** 用户确认删除，**Then** 发票记录从系统删除

---

### User Story 5 - 查看发票详情 (Priority: P2)

作为销售职员，我需要查看发票的完整详细信息。

**Why this priority**: 了解发票完整信息的必要功能

**Independent Test**: 可以通过查看发票详情测试，显示发票的所有字段信息

**Acceptance Scenarios**:

1. **Given** 发票列表中有记录，**When** 用户点击查看详情，**Then** 显示发票详细信息页面

---

### User Story 6 - 发票附件管理 (Priority: P3)

作为销售职员，我需要上传和查看发票附件，以便管理发票相关文件。

**Why this priority**: 纸质发票的电子化存档需要

**Independent Test**: 可以通过上传和查看附件测试，上传发票图片/PDF后可以查看和下载

**Acceptance Scenarios**:

1. **Given** 用户在发票表单中，**When** 上传附件并保存，**Then** 附件与发票记录关联保存
2. **Given** 发票已有附件，**When** 用户查看详情，**Then** 可以查看和下载附件

---

### Edge Cases

- 当关联的销售合同被删除时，发票自动删除（后端级联处理）
- 发票金额不能超过关联合同的剩余未开票金额，系统需在前端进行校验并提示
- 重复的发票号码无需特殊处理

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须显示销售发票列表，包含发票号码、品名、合同编号、开票日期、发票金额
- **FR-002**: 系统必须支持新增发票记录，包含发票号码、关联合同、发票类型、产品数量、发票金额、开票日期
- **FR-003**: 系统必须支持编辑发票记录，修改后保存成功
- **FR-004**: 系统必须支持删除发票记录，删除前需要确认
- **FR-005**: 系统必须显示发票详情页面，展示所有字段信息
- **FR-006**: 系统必须支持发票附件上传和下载
- **FR-007**: 系统必须在开票后自动更新关联销售合同的开票进度（后端自动处理）
- **FR-008**: 系统必须支持发票列表的搜索和筛选功能
- **FR-009**: 系统必须支持发票列表的分页功能
- **FR-010**: 系统必须在新增/编辑发票时校验金额不能超过合同剩余未开票金额，超出时提示错误

### Key Entities

- **发票**: 销售发票记录，包含发票号码、产品名称、关联合同、发票类型、产品数量、发票金额、开票日期、备注、附件、创建人
- **销售合同**: 关联的合同，用于计算开票进度

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 销售职员可以在发票列表页面查看所有发票记录，支持分页
- **SC-002**: 销售职员可以成功新增发票记录，信息完整保存
- **SC-003**: 销售职员可以成功编辑发票记录，修改正确保存
- **SC-004**: 销售职员可以删除发票记录，确认后记录移除
- **SC-005**: 开票后关联销售合同的开票进度自动更新，无需手动操作

### Assumptions

- 后端 PocketBase 已配置 sale_invoices 集合，字段与需求文档一致
- 销售合同数据已存在，可以选择关联
- 后端已实现开票后自动更新合同开票进度的钩子
- 用户已登录，具有 sales 角色权限
